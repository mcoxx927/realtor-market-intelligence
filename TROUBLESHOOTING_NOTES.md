# Dashboard Troubleshooting Notes

## Context
- Investigated charlotte/2025-09/dashboard_enhanced_charlotte_2025-09.html after visuals and dropdowns rendered blank in the browser.
- The HTML was generated by generate_dashboards_v2.py using a plain string builder approach for the JavaScript section.
- Browser console shows syntax errors (e.g., Unexpected token '{', Unexpected token ')') preventing all charts from initializing.

## Findings
- **Double curly braces in output**: Because the JavaScript block is appended with html += ''' (non f-string), every escaped brace {{ / }} is emitted literally, producing invalid JavaScript everywhere (unction exportChartCSV(chartId, filename) {{).
- **Malformed placeholder in ilterDataByRange**: The fallback branch emits periods: labels.map((_, i) => {period}-{{'01': i}}) which references an undefined period variable and outputs more literal braces, leading to an immediate parse failure.
- **Fetch of local JSON**: etch('charlotte_data.json') fails when the dashboard is opened directly via ile:// without a local web server. Script relies on async load for longer ranges, so even after syntax fixes you either need to host via python -m http.server (or similar) or embed the long-range data directly in the HTML.
- **Other HTML artefacts**: Text such as dY"S PNG / dY", CSV originate from manual escaping in the Python template and should be normalised when the template is cleaned up.

## Recommended Fixes (to apply in generate_dashboards_v2.py)
1. Treat the entire JavaScript block as an f-string so escaped braces collapse to single braces. Example:
   `python
   html += f"""
       <script>
       function exportChartCSV(chartId, filename) {{
   """
   `
   In f-strings, escape literal braces with {{ / }}; they will render once.
2. Pre-compute any dynamic JSON strings (e.g., labels_json, inventory_json, etc.) and interpolate them inside the f-string. Add periods_json = json.dumps(labels) (or whatever final list you need) so you can emit a valid fallback array instead of the placeholder logic.
3. Replace periods: labels.map((_, i) => {period}-{{'01': i}}) with a real data structure, e.g. periods_json or labels.map((_, i) => labels[i]). Avoid inline string concatenation that introduces stray braces.
4. Normalise the download button text (use Download PNG / Download CSV) and remove the artefacts from escaped quotes.
5. After fixing the template, regenerate both Charlotte and Roanoke dashboards to ensure the JS in the emitted HTML parses correctly.
6. To keep async data working without a web server, either embed ull_metro_trends / ull_city_trends directly (trade-off: larger HTML) or adjust etch to load via window.location.origin when served, with a documented requirement to open through a local server.

## Suggested Workflow for the Next Session
1. Update generate_dashboards_v2.py per the fixes above.
2. Regenerate dashboard_enhanced_charlotte_2025-09.html and the Roanoke counterpart.
3. Open the new HTML in a browser via python -m http.server (or another local server) to confirm charts load, dropdowns populate, and console logs are clean.
4. Cascade any required adjustments into other pipeline scripts that embed JavaScript snippets (e.g., generate_dashboards.py, create_visualizations.py) so we have consistent templating.

Document created on 2025-10-20 for hand-off to the next Codex session.
