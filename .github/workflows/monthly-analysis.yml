name: Monthly Market Analysis

on:
  schedule:
    # Run on the 22nd of each month at 14:00 UTC (9 AM EST / 10 AM EDT).
    # Redfin releases data on the Friday of the 3rd full week (~15th-21st),
    # so the 22nd gives a comfortable 1+ day buffer.
    - cron: '0 14 22 * *'

  # Manual trigger with optional flags — useful for testing or
  # re-running if Redfin's release was delayed.
  workflow_dispatch:
    inputs:
      skip_ai:
        description: 'Skip AI narrative generation'
        required: false
        default: 'false'
        type: boolean
      force_fetch:
        description: 'Force re-download of Redfin data (ignore cache)'
        required: false
        default: 'false'
        type: boolean

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # Well within GHA's 6-hour limit; pipeline has its own 30-min/script timeout

    env:
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      # ANTHROPIC_MODEL is a GitHub Variable (not a secret — model names aren't sensitive).
      # Set it at: repo Settings → Secrets and variables → Actions → Variables tab.
      # If unset, ai_narrative.py falls back to its hardcoded default.
      ANTHROPIC_MODEL: ${{ vars.ANTHROPIC_MODEL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Write notifications_config.json
        # notifications_config.json is gitignored (contains local secrets).
        # We reconstruct a CI-safe version here so ai_narrative.py picks up
        # the correct model. Email credentials come from env vars, which
        # email_reports.py reads directly, so only the ai_narrative block
        # needs to be in the file.
        run: |
          MODEL="${ANTHROPIC_MODEL:-claude-opus-4-5-20251101}"
          cat > notifications_config.json <<EOF
          {
            "ai_narrative": {
              "enabled": false,
              "api_key": "",
              "model": "${MODEL}",
              "max_tokens": 2000,
              "generate_for_all_metros": true
            }
          }
          EOF
          echo "Config written with model: ${MODEL}"

      - name: Install dependencies
        run: |
          pip install pandas
          # Only install anthropic SDK if an API key is configured
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            pip install anthropic
            echo "Anthropic SDK installed — AI narratives enabled"
          else
            echo "No ANTHROPIC_API_KEY set — AI narratives will be skipped"
          fi

      - name: Fetch Redfin data
        run: |
          if [ "${{ github.event.inputs.force_fetch }}" = "true" ]; then
            python fetch_redfin_data.py --force
          else
            python fetch_redfin_data.py
          fi

      - name: Run analysis pipeline
        run: |
          if [ "${{ github.event.inputs.skip_ai }}" = "true" ]; then
            python run_scheduled.py --no-fetch --no-ai
          else
            python run_scheduled.py --no-fetch
          fi
        # --no-fetch: data was already downloaded in the previous step,
        # which lets us fail fast on fetch errors before spending time on processing.

      - name: Upload market dashboards
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if pipeline partially failed — partial outputs are useful
        with:
          name: market-dashboards-${{ github.run_id }}
          path: |
            core_markets/charlotte/
            core_markets/roanoke/
          if-no-files-found: warn
          retention-days: 90  # Free tier: 500 MB total; these outputs are small

      - name: Upload market radar outputs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: market-radar-${{ github.run_id }}
          path: market_radar/outputs/
          if-no-files-found: ignore
          retention-days: 90

      - name: Upload pipeline log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pipeline-log-${{ github.run_id }}
          path: pipeline_runs.log
          if-no-files-found: ignore
          retention-days: 30
